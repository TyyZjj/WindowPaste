/*
													   .
													. .:...
													   .::::......
													..:^^^~7???J?7~:.
												 .:^~?JYYYPPPPPP555YJ^...
												.:^!YPGPGGBBBBBBGGGPPY^...
												...7PGGGGGBBBBBBBBBBGG57:
										.....   . .JGGBBBBBBB########BG5:
									.^7YPGGGP5~. ..~PB&######&&&GG####BG~.
								  :JG&&&&&&&&#B7 .PY5B&&&&&&&#BJ7Y#&GPPY:.
								^5#&&&&&&&&&&#GP..?&&&&##&&&&BYJ7?P5!^^:.
							   7#&&&&&&&&&&&&&BG~.^#&&&#BGB#&&G7!!7!.:..
							 .Y&&&&&&&&&&&&&&&#G5.:P&&&&&&#BB##J77~. ..
							.P&&&&&&&&&&&&&&&&#GG::!&&&&&&&&&&&B5^
						   ^#&&&&&&&&&&&&&&&&&&GG?::B&&&&&&&&&&&#?.
						  7&&&&&&&&&&&&&&&&&&&&BG5::?&&&&&&&&&&&##P:
						 Y&&&&&@@@&&&&&&&&&&&&&#GG^:~#&&&&&&&&&&&#BG^
					   .P@&&&@@@@@&&&&&&&&&&&&&#GG!::G&&&&&&&&&&&&##B!
					  .P@&@@@@@@@&&&&&&&&&&&&&&&BBY::5&&&&&&&&&&&&&&BG!
					 .5@&&@@@@@@&&&&&&&&&&&&&&&&BBP::?&&&&&&&&&&&&&&&BG~
					 .B@&&&@@@@@&&&&&&&&&&&&&&&&#BB^~!:7P#&&&&&&&&&&&&BG.
					 .Y@&&&@@@@&&&&&&&&&&&&&&&&&#&PJYGG#55@&&&&&&&&&&&#B.
					 .^&@&@@@@@&&&&&&&&&&&&&&&&##Y:^Y&@&#5&&&&&&&&&&&&#B:
					 ..J@&@@@@&&&&&&&&&&&&&&&&&#P:^?&@&&&#P@&&&&&&&&@@#B^
					   :#@@@@&&&&&&&&&&&&&&&&&&G::7&@&&&&@B5@@&&&&&&&@&B:
						7@@@@&&&&&&&&&&&&&&&&&#!.!&@&&&&&&@P?&@&&&&&&@&J
						 ?&@@&&&&&&&&&&&&&&&&&J.^#@&&&&&&&@@5!&@@@@&@@#:
						  ^G&&&&&&&&&&&&&&@@@B..G@&&&&&&&&@@@Y^B@@@@@&#^
							G&&&&&&&&&&&&@&@&~.?@&&&&&&&&&@@@@J.P@@&@&~
							!&&&&&&&&&&&&&&@B!!#@&&&&&&&&&&&&@@?.P@@@J
							.GGB##&&&&&&&@@@PJ&@@@&&&&&&&&&&&&@&~:B@P.
							!57??JYPPGGBBBGG!?GGG#&&&&&&&&&&&&&&#!7J
						  .^??7??JJJJYYY55YYY55Y5PG##&&&&&&&&&&&&P^.
						 :?7777??JJJJJYYYYYYYYYYYYYY5PGB&&&@&Y:~~:.:.
					  . .PJ7??????JJJJJJJJJJJJ????JJJJJYPG7!~   ....  .
					  . ?P77??????JJJJJJJJJJJJJ?JJJJJJYYYPB:
					   .J777?????JJJJJJJJJJJJJJJJJJJJJJJ?J#J:
					   ~?7?????JJJJJJYYYYYYYYYYJYYYJJJJJ?JJY7 ...
					  ^77??????JJJJYYYYYY5555YYYYYYYY5PP5P5J?^  .                         ....
					 :777?????JJJJYYYYY555555555YYY5555YYYJ??J^                           ....
					:77777????JYYYY55555PPPPPP555555555YYJJ?77?!.                         ....
                 .  .77??JJJJJJYY5555PPPGPJ7JGGPPPPP5555YJYYJJJJJ7.                       .....
  ......           .!7??JJJJJYY555PPPGPJ~..  ^PBGGGPPPPPP55YYJJ??J. .......... ................
.   ....          .!77??JJJJYY555PPGP7:       .7GPPPP5555YYYJJJ???. ...........................
....         .   .777????JYYY55PPGG7:.  ...  .  ^GP55555YYYYJJJJJ?. ...........................
:::...      ... .!77??JJJYYY5555G5~. ...... .  . ^PP55555YYYYJJJJ?7  ..........................
:::::...    .. .!77???JJJYYY555GJ.     ....  ...  .5555555YYYYYJJJJ^ ..........................
::::::::....   ~77??JJJJYYY555G!        ...      . ^P555555YYYYYJJJ?. .........................
::::::::::... .?7???JJJJYY55PG7  .............   .  !GP55555YYYYJJJJ^ .........................
::::::::::::..~7777??JY5555GB!  .................... ^PPPP55Y5YYYJJJ~..........................
::::::::::::~7JJYYYYY55PPGBJ.  ...................... :GGPP55555YYJJ!  ........................
::::::::::::!???JYY5PPPPPP:  .......................   ^BB555P55YJJ??^ ........................
:::::::::::^77?YJY55YYY55.  .........................   .7PGPPPPPPPYJJ:........................
::::::::::^!7?7????JY5P5: ..............................   7555555YYY5Y!.......................
:::::::::^!7777JJ?JY55Y^..... ..........................   .7YJ??7???77~ ......................
:::::::::~7777?7?Y55P5^::::... ..........................   :JYJJ??77??7. .....................
::::::::~!7777?JYYY55~:::::::...                     .... . .7JYJ??7777?~ .....................
^^^^^^^^!!!7??JJYY55!:^^^^^:::::.............................^JJJJ???777?:.....................
^^^^^^^~7777??JJYY57^^^^^^^^::::::::::::::::::::::::::::::::::7JJJ???????!:::::::::::::::::::::
^^^^^^^777??JJYYY5J^^^^^::::::::::::::::::::::::::::::::::::::!JJJJ??????7:::::::::::::::::::::
^^^^:^!777??JJYYYY~^::::::::::::::::::::::::::::::::::::::::::~JJJJJJJ????^::::::::::::::::::::
:::::^7777JYYY5Y57::::::::::::::::::::::::::::::::::::::::::::^?JJJJJJJJ??^::::::::::::::::::::
:::::~777?YYY555J^:::::::::::::::::::::::::::::::::::::::::::::7JJJJJ??JJ?!::::::::::::::::::::
::::^!77JYYYYY5Y^:::::::::::::::::::::::::::::::::::::::::::::.!JJJJJ?????7::::::::::::::::::::
::::~!7?JYY555Y~^:::::::::::::::::::::::::::::::::::::::::::::.^?JJJJJ?J???::::::::::::::::::::
:::^!7??JYYYYY!^::::::::::::::::::::::::::::::::::::::::::::::.:?JJJJJJ???J::::::::::::::::::::
:::^!7?JJYYYY!:::.:.::::::.......................:::......::::..~?JJJ??JJJJ^.::::::::::::::::::
:::!77JJYYY5?^::..................................::.......::::.:?JYJJ??JJ?~.::::::::..::::::::
:.!GGB#B5!!~^::::................................................!?7~JP#5JP:..:::..............
::5G#&&&?~^..:::::::::..:............................................!&&&&@Y...................
.!GG####7~^:::::::::.................................................^####&#^..................
:5BBBBB#?~^:.........................................................^#BGGB&5..................
*/


#pragma once
#include <QMap>
#include <QMutex>
#include <QObject>
#include <QString>
#include <QWindow>
#include <QProcess>
#include <QStringList>

struct sProcInfo 
{
	bool				isRunning = false;	//是否正在执行

	QString				strProcPath;		//进程路径
	QString				strDependPath;		//依赖路径
	QStringList			lstUiName;			//画面名

	QString				strProcName;		//进程名称
	QString				strProcFileName;	//进程文件名称(包含后缀)
	/*进程 
		当子进程由父进程启动时, 指针不为空; 否则为空;
		可以用以判断子进程是否由父进程启动*/
	QProcess*			pProc = nullptr;	
	long long			iProcId = 0;		//进程id
	QMap<QString, WId>	mapProcWnd;			//进程下，各个画面名对应的窗口句柄

	bool				bTerminateWhenClose = false;//关闭时, 是否关闭软件

	sProcInfo(){}
	sProcInfo(const sProcInfo &procInfo);

	sProcInfo(const QString &strProcPath,
		const QStringList &lstUiName = QStringList(),
		const QString &strDependPath = QString(),
		const QString &strProcName = QString());
 };
Q_DECLARE_METATYPE(sProcInfo)


//******Taoyuyu***********************   
// 日期: 2023/07/27
// 功能: 多进程的进程开启/关闭, 进程各窗口的管理
//		注意事项: 
//			1、同一路径exe文件, 只能添加一个到监控列表中
//					当目标进程多开时, 仅能实现其中一个进程的监控
//			2、不支持启动时, 传入参数(后续也可以加入参数, 但是这样子进程只能由父进程启动)
//			3、启动进程时, 输入的可执行文件的路径需要是绝对路径, 不支持相对路径
//			4、为了保证多进程时, 各进程之间依赖的路径文件不冲突(如日志、配置等), 应保证各进程有独立的运行目录
// 返回: void
//************************************
class CMultiProcManager : public QObject
{
	Q_OBJECT

public:
	static CMultiProcManager * GetKernel();
	static void DestroyKernel();

	bool kill(sProcInfo &procInfo);
	void start(sProcInfo &procInfo);
	bool remove(sProcInfo &procInfo);

	void setAutoRestartWhenGetWndFailed(bool bAutoRestartWhenGetWndFailed) 
	{ m_bAutoRestartWhenGetWndFailed = bAutoRestartWhenGetWndFailed; }

	bool setDenseInterval(int interval) { 
		if (interval > 0 &&
			interval < m_iLooseInterval)
		{
			m_iDenseInterval = interval;
			return true;
		}
		return false;
	}
	bool setLooseInterval(int interval) { 
		if (interval > 0 &&
			interval > m_iDenseInterval)
		{
			m_iLooseInterval = interval;
			return true;
		}
		return false;
	}

Q_SIGNALS:
	void signalProcessStarted(sProcInfo procInfo);
	void signalProcessError(const QString strError);

private:
	CMultiProcManager(QObject *parent = nullptr);
	~CMultiProcManager();

	//******Taoyuyu***********************   
	// 日期: 2023/07/27
	// 功能: 定时查看是否所有目标进程都已启动, 或者所有目标窗口都已获取.
	//			如果没有目标进程/窗口, 则创建
	// 返回: void
	//************************************
	void OnTimer();

	bool isProcInManager(const sProcInfo &procInfo);//快速简单判断进程是否存在(是否已经在进程监控中)
	bool isProcExist(sProcInfo &procInfo);//进程是否存在
	bool isAllProcInManager();
	bool isAllProcExist();//是否所有目标进程都存在
	bool isWndInManager(const sProcInfo &procInfo);//快速简单判断窗口是否存在(是否已经在窗口监控中)
	bool isAllWndInManager();//是否所有目标窗口都存在

	//获取进程的可执行文件路径
	QString getExecutablePathFromProcessId(qint64 processId);

private:
	static CMultiProcManager*		m_pInstance;

	QMutex						m_mutexProcInfo;	//
	/*
	任务进程列表  QMap<进程路径, sProcInfo>
	注意: 以任务路径为key值, 代表同一路径下的exe,只能单例运行; 或者多次运行后,只能绑定其中一个进程
	*/
	QMap<QString, sProcInfo>	m_mapProcInfo;

	QTimer*	m_pTimer;			//进程Timer

	/*
	获取进程窗口失败时, 是否自动重启进程
	注意: 可能存在一种情况: 进程启动之后, 可能画面不会立即启动，此时有可能无法获取画面.
		此时如果重启进程, 可能会导致始终无法获取画面
		此配置要和 m_iDenseInterval 配合使用
	*/
	bool	m_bAutoRestartWhenGetWndFailed = false;

	int		m_iDenseInterval = 1000;	//密集间隔
	int		m_iLooseInterval = 10000;	//疏松间隔
};
